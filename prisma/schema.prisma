// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. AUTH.JS MODELS (NextAuth v5 Standard)
// ==========================================

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime? // Auth.js menggunakan DateTime, bukan Boolean
  image         String?
  role          AppRole   @default(MEMBER)

  // --- VATSIM Custom Fields ---
  cid          String       @unique
  ratingId     Int          @default(1) // 1
  ratingShort  String? // "OBS"
  ratingLong   String?
  region       String?
  division     String?
  subdivision  String?
  rosterStatus RosterStatus @default(VISITOR)
  joinDate     DateTime     @default(now())

  // --- Relations ---
  accounts Account[]
  sessions Session[]

  // Training & Roster Relations
  trainingsAsStudent Training[]        @relation("StudentTrainings")
  trainingsAsMentor  Training[]        @relation("MentorTrainings")
  trainingSessions   TrainingSession[] @relation("MentorSessions")
  certificates       UserCertificate[]
  issuedCertificates UserCertificate[] @relation("Issuer")

  // Exam Relations
  examSubmissions ExamSubmission[]
  courseProgress  CourseProgress[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([role])
  @@index([ratingId])
  @@index([cid])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String // Ini akan menyimpan CID dari VATSIM
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// ==========================================
// 2. ROSTER & CERTIFICATES
// ==========================================

model Certificate {
  id          String  @id @default(cuid())
  code        String  @unique // DEL, GND, TWR, etc
  name        String
  description String?

  userCertificates UserCertificate[]
}

model UserCertificate {
  id            String  @id @default(cuid())
  userId        String
  certificateId String
  issuerId      String? // Mentor/Admin yang memberikan

  issuedAt   DateTime   @default(now())
  validUntil DateTime?
  status     CertStatus @default(ACTIVE)

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  issuer      User?       @relation("Issuer", fields: [issuerId], references: [id])
  certificate Certificate @relation(fields: [certificateId], references: [id], onDelete: Restrict)

  @@unique([userId, certificateId])
  @@index([userId])
}

// ==========================================
// 3. TRAINING SYSTEM (With Solo Detail)
// ==========================================

model Training {
  id        String  @id @default(cuid())
  studentId String
  mentorId  String?

  title  String // e.g. "S2 Tower Training"
  status TrainingStatus @default(IN_PROGRESS)
  notes  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student User  @relation("StudentTrainings", fields: [studentId], references: [id], onDelete: Cascade)
  mentor  User? @relation("MentorTrainings", fields: [mentorId], references: [id])

  sessions   TrainingSession[]
  soloDetail TrainingSoloDetail? // Link ke detail solo jika ada

  @@index([studentId])
  @@index([mentorId])
}

model TrainingSoloDetail {
  id         String @id @default(cuid())
  trainingId String @unique

  position   String // e.g. "WIII_TWR"
  validFrom  DateTime  @default(now())
  validUntil DateTime? // Tanggal expired solo

  training Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
}

model TrainingSession {
  id         String @id @default(cuid())
  trainingId String
  mentorId   String

  startTime DateTime
  endTime   DateTime?
  position  String

  summary     String?
  privateNote String?

  rating SessionRating @default(SATISFACTORY)

  training Training @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  mentor   User     @relation("MentorSessions", fields: [mentorId], references: [id])

  createdAt DateTime @default(now())

  @@index([trainingId])
  @@index([startTime])
  @@index([mentorId])
}

// ==========================================
// 4. LMS & EXAMS
// ==========================================

model Course {
  id          String  @id @default(cuid())
  title       String
  description String?
  minRating   Int?
  isPublished Boolean @default(false)

  modules       Module[]
  progress      CourseProgress[]
  unlockedExams Exam[]           @relation("CourseToExam")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Module {
  id       String     @id @default(cuid())
  courseId String
  title    String
  content  String?
  order    Int        @default(0)
  type     ModuleType @default(TEXT)

  exam Exam?

  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@index([courseId])
}

model Exam {
  id             String  @id @default(cuid())
  moduleId       String? @unique
  title          String
  passingScore   Int     @default(80)
  prerequisiteId String?
  prerequisite   Course? @relation("CourseToExam", fields: [prerequisiteId], references: [id])
  questionCount  Int     @default(0)
  isSelection    Boolean @default(false)
  minRating      Int     @default(0)

  questions   Question[]
  submissions ExamSubmission[]

  module Module? @relation(fields: [moduleId], references: [id], onDelete: SetNull)
}

model Question {
  id     String       @id @default(cuid())
  examId String
  text   String
  type   QuestionType
  points Int          @default(1)
  order  Int          @default(0)

  options QuestionOption[]
  answers ExamAnswer[]

  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)
}

model QuestionOption {
  id         String  @id @default(cuid())
  questionId String
  text       String
  isCorrect  Boolean @default(false)

  question    Question     @relation(fields: [questionId], references: [id], onDelete: Cascade)
  examAnswers ExamAnswer[]
}

model ExamSubmission {
  id     String @id @default(cuid())
  examId String
  userId String

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  score  Float?
  status SubmissionStatus @default(IN_PROGRESS)

  adminFeedback  String?
  answers        ExamAnswer[]
  generatedCode  String? // Kode unik jika lulus (e.g. SEL-2025-X)
  appReason      String?      @db.Text
  appExpectation String?      @db.Text

  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([examId])
  @@index([status])
  @@index([generatedCode])
}

model ExamAnswer {
  id           String @id @default(cuid())
  submissionId String
  questionId   String

  selectedOptionId String?
  textAnswer       String?

  isCorrect     Boolean?
  pointsAwarded Int      @default(0)

  submission     ExamSubmission  @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  question       Question        @relation(fields: [questionId], references: [id], onDelete: Cascade)
  selectedOption QuestionOption? @relation(fields: [selectedOptionId], references: [id]) // Diperbaiki: Relasi optional ke QuestionOption
}

model CourseProgress {
  id          String    @id @default(cuid())
  userId      String
  courseId    String
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
}

// ==========================================
// 5. ENUMS
// ==========================================

enum RosterStatus {
  ACTIVE
  INACTIVE
  LOA
  VISITOR
  SUSPENDED
  RESIDENT
}

enum CertStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum TrainingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum SessionRating {
  UNSATISFACTORY
  SATISFACTORY
  EXCELLENT
}

enum QuestionType {
  MULTIPLE_CHOICE
  TRUE_FALSE
  ESSAY
}

enum SubmissionStatus {
  IN_PROGRESS
  PENDING_REVIEW
  PASSED
  FAILED
}

enum ModuleType {
  TEXT
  SLIDE
}

enum AppRole {
  ADMIN
  STAFF
  MENTOR
  MEMBER
}
